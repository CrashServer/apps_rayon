<!-- index.html - Main HTML file for the Audio Generator -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rayon - Audio Live Coding</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
  <link rel="stylesheet" href="supermarketjs/_consume-style.css">
</head>
<body>
  <div class="header-container">
    <div class="header-left">
      <h1 class="title">Rayon</h1>
      <div class="alpha-notice">Alpha</div>
    </div>
    <div class="header-shortcuts">
      <span class="shortcut"><kbd>Ctrl</kbd>+<kbd>Enter</kbd> Run line</span>
      <span class="shortcut"><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>Enter</kbd> Run all</span>
      <span class="shortcut"><kbd>Esc</kbd> Stop</span>
      <span class="shortcut"><kbd>Tab</kbd> Autocomplete</span>
    </div>
    <div class="header-right">
      <button class="header-btn" id="about-btn">About</button>
    </div>
  </div>

  <!-- About Modal -->
  <div id="about-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <button class="modal-close" id="close-about">&times;</button>
      <h2>Rayon</h2>
      <p class="about-subtitle">Audio Live Coding Environment</p>

      <div class="about-section">
        <h3>What is Rayon?</h3>
        <p>Rayon is a browser-based audio synthesis environment that uses shopping metaphors for live coding music. Products become synthesizers, shopping carts provide rhythm, and retail concepts control musical parameters.</p>
      </div>

      <div class="about-section">
        <h3>How to use</h3>
        <ul>
          <li><strong>Add products</strong> - Type <code>[0] add beer</code> or <code>[1] add fresh salad</code> (slots 0-9)</li>
          <li><strong>Replace a slot</strong> - Same slot number replaces synth on next bar</li>
          <li><strong>Add rhythm</strong> - Type <code>my cart has square wheels</code></li>
          <li><strong>Apply effects</strong> - Use modifiers like <code>cheap</code>, <code>expensive</code>, <code>industrial</code></li>
          <li><strong>Story mode</strong> - Type <code>story mode</code> for a guided tutorial</li>
        </ul>
      </div>

      <div class="about-section">
        <h3>Credits</h3>
        <p>Created by <a href="https://crashserver.fr" target="_blank">CrashServer</a></p>
        <p>Built with <a href="https://tonejs.github.io/" target="_blank">Tone.js</a> for audio synthesis.</p>
      </div>

      <div class="about-links">
        <a href="https://crashserver.fr" target="_blank">crashserver.fr</a>
        <a href="supdoc/en.html" target="_blank">Documentation</a>
      </div>
    </div>
  </div>

  <div class="quick-ref-compact">
    <div class="ref-tabs">
      <button class="ref-tab active" data-tab="products">Products</button>
      <button class="ref-tab" data-tab="modifiers">Modifiers</button>
      <button class="ref-tab" data-tab="parameters">Parameters</button>
      <button class="ref-tab" data-tab="modes">Modes</button>
      <button class="ref-tab" data-tab="cart">Cart Wheels</button>
      <button class="ref-tab" data-tab="store">Store</button>
      <button class="ref-tab" data-tab="special">Special</button>
      <button class="ref-tab" data-tab="breaks">Breaks</button>
      <button class="ref-tab" data-tab="transitions">Transitions</button>
      <button class="ref-tab" data-tab="theft">Theft</button>
      <button class="ref-tab" data-tab="performance">Performance</button>
    </div>
    
    <div class="ref-content">
      <div class="ref-panel active" id="products-panel">
        <div class="ref-grid">
          <span class="ref-item clickable" data-type="product" data-insert="[0] add beer" title="Mellow FM synth - smooth jazzy tones">beer</span>
          <span class="ref-item clickable" data-type="product" data-insert="[1] add salad" title="Crisp pluck synth - fresh texture">salad</span>
          <span class="ref-item clickable" data-type="product" data-insert="[2] add ham" title="Rich fat sawtooth - savory depth">ham</span>
          <span class="ref-item clickable" data-type="product" data-insert="[3] add milk" title="Soft pluck synth - liquid smooth">milk</span>
          <span class="ref-item clickable" data-type="product" data-insert="[4] add chips" title="Crispy sawtooth with filter sweep">chips</span>
          <span class="ref-item clickable" data-type="product" data-insert="[5] add pizza" title="Triangle wave FM synth - warm tones">pizza</span>
          <span class="ref-item clickable" data-type="product" data-insert="[6] add oil" title="Low frequency sine wave - liquid bass">oil</span>
          <span class="ref-item clickable" data-type="product" data-insert="[7] add wine" title="Detuned poly synth - complex layers">wine</span>
          <span class="ref-item clickable" data-type="product" data-insert="[8] add cheese" title="Warm FM synth - smooth harmonics">cheese</span>
          <span class="ref-item clickable" data-type="product" data-insert="[9] add soda" title="High pitched membrane synth - fizzy">soda</span>
          <span class="ref-item clickable" data-type="product" data-insert="[0] add bread" title="Warm duo synth - soft and full">bread</span>
          <span class="ref-item clickable" data-type="product" data-insert="[1] add cereal" title="Crunchy granular synth - textured">cereal</span>
          <span class="ref-item clickable" data-type="product" data-insert="[2] add chocolate" title="Rich square wave AM synth - sweet">chocolate</span>
          <span class="ref-item clickable" data-type="product" data-insert="[3] add candy" title="Bright sawtooth mono synth - sugary">candy</span>
          <span class="ref-item clickable" data-type="product" data-insert="[4] add energy_drink" title="Buzzy FM synth - energetic">energy_drink</span>
          <span class="ref-item clickable" data-type="product" data-insert="[5] add coffee" title="Dark filtered sawtooth - caffeinated">coffee</span>
          <span class="ref-item clickable" data-type="product" data-insert="[6] add butter" title="Creamy detuned duo synth - smooth">butter</span>
          <span class="ref-item clickable" data-type="product" data-insert="[7] add eggs" title="Plucked string with bright attack">eggs</span>
          <span class="ref-item clickable" data-type="product" data-insert="[8] add pasta" title="Soft poly synth - Italian warmth">pasta</span>
          <span class="ref-item clickable" data-type="product" data-insert="[9] add rice" title="Short noise bursts - grainy texture">rice</span>
        </div>
      </div>
      
      <div class="ref-panel" id="modifiers-panel">
        <div class="ref-grid">
          <span class="ref-item clickable" data-type="modifier" data-insert="fresh" title="Higher pitch, brighter sound">fresh</span>
          <span class="ref-item clickable" data-type="modifier" data-insert="old" title="Lower pitch, darker sound">old</span>
          <span class="ref-item clickable" data-type="modifier" data-insert="strong" title="Lowpass filter, deeper tone">strong</span>
          <span class="ref-item clickable" data-type="modifier" data-insert="flavorless" title="Highpass filter, thin sound">flavorless</span>
          <span class="ref-item clickable" data-type="modifier" data-insert="cheap" title="Bitcrusher effect, lo-fi digital">cheap</span>
          <span class="ref-item clickable" data-type="modifier" data-insert="expensive" title="Reverb effect, spacious sound">expensive</span>
          <span class="ref-item clickable" data-type="modifier" data-insert="processed" title="Chorus effect, thick texture">processed</span>
          <span class="ref-item clickable" data-type="modifier" data-insert="industrial" title="Distortion effect, harsh tone">industrial</span>
          <span class="ref-item clickable" data-type="modifier" data-insert="overpriced" title="Phaser effect, swirling motion">overpriced</span>
          <span class="ref-item clickable" data-type="modifier" data-insert="vomit" title="Chebyshev waveshaper, extreme distortion">vomit</span>
          <span class="ref-item clickable" data-type="modifier" data-insert="artisanal" title="Tremolo effect, amplitude wobble">artisanal</span>
          <span class="ref-item clickable" data-type="modifier" data-insert="bargain" title="Feedback delay, echoing repeats">bargain</span>
          <span class="ref-item clickable" data-type="modifier" data-insert="luxury" title="Long reverb, premium space">luxury</span>
          <span class="ref-item clickable" data-type="modifier" data-insert="artificial" title="Vibrato effect, pitch wobble">artificial</span>
          <span class="ref-item clickable" data-type="modifier" data-insert="mass-produced" title="Heavy bitcrusher, ultra lo-fi">mass-produced</span>
          <span class="ref-item clickable" data-type="modifier" data-insert="addictive" title="Ping-pong delay, stereo bounce">addictive</span>
          <span class="ref-item clickable" data-type="modifier" data-insert="packaged" title="Rhythmic tremolo with filter (beer, chocolate, energy_drink)">packaged</span>
          <span class="ref-item clickable" data-type="modifier" data-insert="glass" title="Shimmering echo effect (beer, chocolate, energy_drink)">glass</span>
        </div>
      </div>
      
      <div class="ref-panel" id="parameters-panel">
        <div class="ref-grid">
          <span class="ref-item clickable" data-type="parameter" data-insert="nutriscore A" title="Key of A">nutriscore A</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="nutriscore B" title="Key of B">nutriscore B</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="nutriscore C" title="Key of C">nutriscore C</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="nutriscore D" title="Key of D">nutriscore D</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="nutriscore E" title="Key of E">nutriscore E</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="shelflife today" title="Very short duration">shelflife today</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="shelflife week" title="Short duration">shelflife week</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="shelflife month" title="Medium duration">shelflife month</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="shelflife year" title="Long duration">shelflife year</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="shelflife forever" title="Infinite duration">shelflife forever</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="open" title="Plays only ~60% of the time">open</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="escalator up" title="Ascending arpeggio">escalator up</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="escalator down" title="Descending arpeggio">escalator down</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="escalator bounce" title="Up then down">escalator bounce</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="escalator zigzag" title="Alternating pattern">escalator zigzag</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="escalator express" title="Random fast pattern">escalator express</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="escalator checkout" title="Barcode scanner rhythm">escalator checkout</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="escalator slow" title="Slow speed">escalator slow</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="escalator fast" title="Fast speed">escalator fast</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="escalator rush" title="Very fast speed">escalator rush</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="escalator broken" title="Irregular timing">escalator broken</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="volume max" title="Maximum volume">volume max</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="volume loud" title="High volume">volume loud</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="volume soft" title="Low volume">volume soft</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="volume quiet" title="Very low volume">volume quiet</span>
          <span class="ref-item clickable" data-type="parameter" data-insert="volume mute" title="Silent">volume mute</span>
        </div>
      </div>

      <div class="ref-panel" id="modes-panel">
        <div class="ref-grid">
          <span class="ref-item clickable" data-type="mode" data-insert="discount mode on" title="Detunes everything slightly">discount on</span>
          <span class="ref-item clickable" data-type="mode" data-insert="inflation mode on" title="Pitch shifts everything up">inflation on</span>
          <span class="ref-item clickable" data-type="mode" data-insert="consumerism mode on" title="Adds delays to everything">consumerism on</span>
          <span class="ref-item clickable" data-type="mode" data-insert="black_friday mode on" title="Chaotic distortion effect">black_friday on</span>
          <span class="ref-item clickable" data-type="mode" data-insert="discount mode off" title="Turn off discount mode">discount off</span>
          <span class="ref-item clickable" data-type="mode" data-insert="inflation mode off" title="Turn off inflation mode">inflation off</span>
          <span class="ref-item clickable" data-type="mode" data-insert="consumerism mode off" title="Turn off consumerism mode">consumerism off</span>
          <span class="ref-item clickable" data-type="mode" data-insert="black_friday mode off" title="Turn off black friday mode">black_friday off</span>
        </div>
      </div>
      
      <div class="ref-panel" id="cart-panel">
        <div class="ref-grid">
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has square wheels" title="Steady 4/4 beat">square wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has broken wheels" title="Glitchy irregular rhythm">broken wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has premium wheels" title="Smooth swing rhythm">premium wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has defective wheels" title="Chaotic polyrhythm">defective wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has bargain wheels" title="Simple minimal beat">bargain wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has luxury wheels" title="Complex jazz rhythm">luxury wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has heavy wheels" title="Kick-heavy techno pattern">heavy wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has chrome wheels" title="Crisp digital beats">chrome wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has turbo wheels" title="Fast breakbeat rhythm">turbo wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has plastic wheels" title="Synthetic artificial drums">plastic wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has wobbly wheels" title="Dubstep wobble bass">wobbly wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has squeaky wheels" title="Hi-hat focused shuffle">squeaky wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has rubber wheels" title="Bouncy funk rhythm">rubber wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has smooth wheels" title="Liquid drum'n'bass flow">smooth wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has rusty wheels" title="Industrial metallic">rusty wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has vintage wheels" title="Classic 808/909">vintage wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has stolen wheels" title="Erratic unpredictable">stolen wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has golden wheels" title="Luxurious trap hi-hats">golden wheels</span>
          <span class="ref-item clickable" data-type="cart" data-insert="my cart has no wheels" title="No rhythm">no wheels</span>
        </div>
      </div>
      
      <div class="ref-panel" id="store-panel">
        <div class="ref-grid">
          <span class="ref-item clickable" data-type="store" data-insert="checkout" title="Start recording performance">checkout</span>
          <span class="ref-item clickable" data-type="store" data-insert="finish checkout" title="Stop recording and save">finish checkout</span>
          <span class="ref-item clickable" data-type="store" data-insert="scan barcode 123456" title="Generate products from barcode">scan barcode</span>
          <span class="ref-item clickable" data-type="store" data-insert="season halloween" title="Spooky seasonal theme">halloween</span>
          <span class="ref-item clickable" data-type="store" data-insert="season christmas" title="Festive holiday theme">christmas</span>
          <span class="ref-item clickable" data-type="store" data-insert="season summer" title="Bright summer vibes">summer</span>
          <span class="ref-item clickable" data-type="store" data-insert="season winter" title="Cold crisp sounds">winter</span>
          <span class="ref-item clickable" data-type="store" data-insert="season easter" title="Bouncy spring theme">easter</span>
          <span class="ref-item clickable" data-type="store" data-insert="season valentines" title="Romantic ambience">valentines</span>
          <span class="ref-item clickable" data-type="store" data-insert="season normal" title="Back to regular theme">normal season</span>
          <span class="ref-item clickable" data-type="store" data-insert="announcement cleanup" title="Cleanup on aisle 3">cleanup announce</span>
          <span class="ref-item clickable" data-type="store" data-insert="announcement closing" title="Store closing soon">closing announce</span>
          <span class="ref-item clickable" data-type="store" data-insert="announcement sale" title="Special offer">sale announce</span>
          <span class="ref-item clickable" data-type="store" data-insert="rush hour on" title="Frantic shopping chaos">rush hour on</span>
          <span class="ref-item clickable" data-type="store" data-insert="rush hour off" title="End rush hour">rush hour off</span>
          <span class="ref-item clickable" data-type="store" data-insert="store layout" title="View store layout">store layout</span>
          <span class="ref-item clickable" data-type="store" data-insert="map compose" title="Spatial sequencer mode">map compose</span>
        </div>
      </div>
      
      <div class="ref-panel" id="special-panel">
        <div class="ref-grid">
          <span class="ref-item clickable" data-type="special" data-insert="apply coupon BOGO" title="Buy one get one - duplicates products">BOGO coupon</span>
          <span class="ref-item clickable" data-type="special" data-insert="apply coupon 50OFF" title="50% off - half speed">50OFF coupon</span>
          <span class="ref-item clickable" data-type="special" data-insert="apply coupon FREESHIP" title="Free shipping - spacious reverb">FREESHIP coupon</span>
          <span class="ref-item clickable" data-type="special" data-insert="apply coupon VIP" title="VIP access - luxury effects">VIP coupon</span>
          <span class="ref-item clickable" data-type="special" data-insert="decay on" title="Products start expiring">decay on</span>
          <span class="ref-item clickable" data-type="special" data-insert="decay off" title="Stop product decay">decay off</span>
          <span class="ref-item clickable" data-type="special" data-insert="preserve beer" title="Preserve specific product">preserve product</span>
          <span class="ref-item clickable" data-type="special" data-insert="spoil all" title="Instantly spoil all products">spoil all</span>
          <span class="ref-item clickable" data-type="special" data-insert="it's closing time" title="Speed up tempo">closing time</span>
          <span class="ref-item clickable" data-type="special" data-insert="it's opening time" title="Slow down tempo">opening time</span>
          <span class="ref-item clickable" data-type="special" data-insert="[0] add beer&#10;[1] add chips" title="Friday Night party mode - add both for auto combo">combo: party</span>
          <span class="ref-item clickable" data-type="special" data-insert="[0] add milk&#10;[1] add cereal" title="Morning routine - add both for auto combo">combo: morning</span>
          <span class="ref-item clickable" data-type="special" data-insert="[0] add wine&#10;[1] add cheese" title="Sophisticated jazz - add both for auto combo">combo: jazz</span>
          <span class="ref-item clickable" data-type="special" data-insert="[0] add bread&#10;[1] add ham" title="Lunch break - add both for auto combo">combo: lunch</span>
          <span class="ref-item clickable" data-type="special" data-insert="[0] add energy_drink&#10;[1] add candy" title="Sugar rush - add both for auto combo">combo: sugar</span>
          <span class="ref-item clickable" data-type="special" data-insert="[0] add oil&#10;[1] add salad" title="Health conscious - add both for auto combo">combo: zen</span>
        </div>
      </div>
      
      <div class="ref-panel" id="theft-panel">
        <div class="ref-grid">
          <span class="ref-item clickable" data-type="theft" data-insert="shoplift beer" title="Attempt to steal beer">shoplift beer</span>
          <span class="ref-item clickable" data-type="theft" data-insert="steal chips" title="Try to steal chips">steal chips</span>
          <span class="ref-item clickable" data-type="theft" data-insert="pocket candy" title="Pocket some candy">pocket candy</span>
          <span class="ref-item clickable" data-type="theft" data-insert="five finger discount wine" title="The classic theft">5 finger wine</span>
          <span class="ref-item clickable" data-type="theft" data-insert="security level low" title="Easy mode - 30% security">security low</span>
          <span class="ref-item clickable" data-type="theft" data-insert="security level medium" title="Normal security - 50%">security medium</span>
          <span class="ref-item clickable" data-type="theft" data-insert="security level high" title="Tough security - 70%">security high</span>
          <span class="ref-item clickable" data-type="theft" data-insert="security level paranoid" title="Maximum security - 95%">security paranoid</span>
          <span class="ref-item clickable" data-type="theft" data-insert="security chase on" title="Activate pursuit mode">chase mode</span>
          <span class="ref-item clickable" data-type="theft" data-insert="security chase off" title="End the chase">chase off</span>
          <span class="ref-item clickable" data-type="theft" data-insert="shoplifting stats" title="View theft statistics">theft stats</span>
        </div>
      </div>
      
      <div class="ref-panel" id="breaks-panel">
        <div class="ref-grid">
          <span class="ref-item clickable" data-type="break" data-insert="checkout line" title="Fade to silence in checkout queue">checkout line</span>
          <span class="ref-item clickable" data-type="break" data-insert="lunch break" title="Drums stop, music softens">lunch break</span>
          <span class="ref-item clickable" data-type="break" data-insert="lunch break off" title="Resume full energy">lunch break off</span>
          <span class="ref-item clickable" data-type="break" data-insert="store closing" title="Everything fades away">store closing</span>
          <span class="ref-item clickable" data-type="break" data-insert="cleanup time" title="Only muzak remains">cleanup time</span>
          <span class="ref-item clickable" data-type="break" data-insert="intermission" title="Pause time briefly">intermission</span>
          <span class="ref-item clickable" data-type="break" data-insert="pause shopping" title="Alternative: pause time">pause shopping</span>
          <span class="ref-item clickable" data-type="break" data-insert="coffee break" title="Quick fade out/in">coffee break</span>
          <span class="ref-item clickable" data-type="break" data-insert="smoke break" title="Step outside briefly">smoke break</span>
        </div>
      </div>
      
      <div class="ref-panel" id="transitions-panel">
        <div class="ref-grid">
          <span class="ref-item clickable" data-type="transition" data-insert="conveyor belt" title="Products roll in sequence">conveyor belt</span>
          <span class="ref-item clickable" data-type="transition" data-insert="conveyor belt fast" title="Quick conveyor effect">conveyor fast</span>
          <span class="ref-item clickable" data-type="transition" data-insert="conveyor belt slow" title="Slow conveyor effect">conveyor slow</span>
          <span class="ref-item clickable" data-type="transition" data-insert="sliding doors" title="Stereo pan sweep">sliding doors</span>
          <span class="ref-item clickable" data-type="transition" data-insert="elevator music" title="Muffled distant sound">elevator music</span>
          <span class="ref-item clickable" data-type="transition" data-insert="muzak" title="Alternative: elevator music">muzak</span>
          <span class="ref-item clickable" data-type="transition" data-insert="smooth transition" title="Crossfade between groups">smooth transition</span>
          <span class="ref-item clickable" data-type="transition" data-insert="crossfade" title="Alternative: smooth transition">crossfade</span>
          <span class="ref-item clickable" data-type="transition" data-insert="fade to silence" title="Gradual fade to quiet">fade to silence</span>
          <span class="ref-item clickable" data-type="transition" data-insert="fade to soft" title="Fade to background level">fade to soft</span>
          <span class="ref-item clickable" data-type="transition" data-insert="fade to full" title="Fade to full volume">fade to full</span>
          <span class="ref-item clickable" data-type="transition" data-insert="morph to beer" title="Transform all to beer">morph to beer</span>
          <span class="ref-item clickable" data-type="transition" data-insert="morph to salad" title="Transform all to salad">morph to salad</span>
          <span class="ref-item clickable" data-type="transition" data-insert="morph to chips" title="Transform all to chips">morph to chips</span>
          <span class="ref-item clickable" data-type="transition" data-insert="morph to coffee" title="Transform all to coffee">morph to coffee</span>
        </div>
      </div>

      <div class="ref-panel" id="performance-panel">
        <div class="ref-grid">
          <span class="ref-item clickable" data-type="performance" data-insert="performance mode performance" title="Optimized for stability">performance mode</span>
          <span class="ref-item clickable" data-type="performance" data-insert="performance mode quality" title="Maximum audio fidelity">quality mode</span>
          <span class="ref-item clickable" data-type="performance" data-insert="performance mode balanced" title="Balance of quality and performance">balanced mode</span>
          <span class="ref-item clickable" data-type="performance" data-insert="performance stats" title="Show voice count and dropouts">performance stats</span>
        </div>
      </div>

    </div>
  </div>

  <!-- Main split-screen container -->
  <div class="main-container">
    <!-- Left panel - Editor -->
    <div class="editor-panel">
      <div id="editor-container">
        <div class="editor-tabs">
          <button class="editor-tab active" data-tab="0">Intro</button>
          <button class="editor-tab" data-tab="1">Tab 1</button>
          <button class="editor-tab" data-tab="2">Tab 2</button>
          <button class="editor-tab" data-tab="3">Tab 3</button>
          <button class="editor-tab" data-tab="4">Tab 4</button>
          <button class="editor-tab" data-tab="5">Tab 5</button>
          <button class="editor-tab" data-tab="6">Tab 6</button>
          <button class="editor-tab" data-tab="7">Tab 7</button>
          <button class="editor-tab" data-tab="8">Tab 8</button>
          <button class="editor-tab" data-tab="9">Tab 9</button>
        </div>
        <textarea id="editor"></textarea>
      </div>

      <div class="control-panel">
        <button id="run-all" class="control-button green">Run All</button>
        <button id="run-line" class="control-button blue">Run Current Line</button>
        <button id="stop" class="control-button red">Stop All</button>
        <button id="clear-all" class="control-button orange">Clear Products</button>
        <button id="randomize" class="control-button yellow">üé≤ Random Command</button>
      </div>
    </div>

    <!-- Right panel - Output and visualization -->
    <div class="output-panel">
      <div id="output-container">
        <div id="output">Abandoned supermarket awaiting your commands... The products are calling to you...<br><br>
üÜï NEW: Type 'story mode' to start the guided experience!<br>
Or dive right in with commands like '[0] add beer' (slots 0-9) or check the reference tabs above.</div>
        <div id="wheel-pattern" style="display: none;"></div>
      </div>

      <div id="visualization-container">
        <div class="viz-tabs">
          <button class="viz-tab active" data-viz-tab="products">Active Products</button>
          <button class="viz-tab" data-viz-tab="settings">Settings</button>
        </div>
        <div class="viz-panel active" id="viz-products-panel">
          <div id="cart-wheels-visualizer" class="cart-visualizer" style="display: none;">
            <div class="cart-icon">üõí</div>
            <div class="cart-info">
              <div class="cart-label">Cart Wheels</div>
              <div class="cart-type" id="cart-wheel-type">none</div>
            </div>
            <div class="cart-animation">
              <div class="wheel wheel-1"></div>
              <div class="wheel wheel-2"></div>
            </div>
            <div class="cart-stop-hint">Click to stop</div>
          </div>
          <div id="active-synths" class="synth-grid"></div>
        </div>
        <div class="viz-panel" id="viz-settings-panel">
          <div class="settings-content">
            <div class="settings-section">
              <h4>Auto Modes</h4>
              <label class="toggle-row">
                <span>Auto-detect combos (party mode, etc.)</span>
                <input type="checkbox" id="auto-combos-toggle" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="settings-section">
              <h4>Visual Feedback</h4>
              <label class="toggle-row">
                <span>Show popup messages</span>
                <input type="checkbox" id="popup-messages-toggle" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>

            <div class="settings-section">
              <h4>Theme</h4>
              <div class="theme-selector">
                <button class="theme-btn active" data-theme="default" title="Default">
                  <span class="theme-preview" style="background: linear-gradient(135deg, #80d8c0, #8fc98a);"></span>
                  <span>Mint</span>
                </button>
                <button class="theme-btn" data-theme="sunset" title="Sunset">
                  <span class="theme-preview" style="background: linear-gradient(135deg, #f0a890, #e8c878);"></span>
                  <span>Sunset</span>
                </button>
                <button class="theme-btn" data-theme="ocean" title="Ocean">
                  <span class="theme-preview" style="background: linear-gradient(135deg, #88c8e8, #80d8c0);"></span>
                  <span>Ocean</span>
                </button>
                <button class="theme-btn" data-theme="lavender" title="Lavender">
                  <span class="theme-preview" style="background: linear-gradient(135deg, #c4a8e0, #f0a890);"></span>
                  <span>Lavender</span>
                </button>
                <button class="theme-btn" data-theme="mono" title="Mono">
                  <span class="theme-preview" style="background: linear-gradient(135deg, #a8a098, #f0ebe5);"></span>
                  <span>Mono</span>
                </button>
              </div>
            </div>

            <div class="settings-section">
              <h4>Recording</h4>
              <div class="record-buttons">
                <button class="record-btn" id="record-audio-btn">
                  <span class="record-icon">‚óè</span> Record Audio
                </button>
                <button class="record-btn" id="record-video-btn">
                  <span class="record-icon">‚óè</span> Record Audio + Video
                </button>
              </div>
              <div id="recording-status" class="recording-status"></div>
            </div>

            <div class="settings-section">
              <h4>Performance</h4>
              <div class="preset-buttons">
                <button class="preset-btn" data-preset="quality" title="Maximum audio quality">
                  Quality
                  <span class="preset-desc">Best sound</span>
                </button>
                <button class="preset-btn active" data-preset="balanced" title="Good balance">
                  Balanced
                  <span class="preset-desc">Recommended</span>
                </button>
                <button class="preset-btn" data-preset="performance" title="Optimized for stability">
                  Performance
                  <span class="preset-desc">Low CPU</span>
                </button>
              </div>
            </div>

            <div class="settings-section">
              <h4>Status</h4>
              <div class="performance-status">
                <div class="status-row">
                  <span>Mode:</span>
                  <span id="current-mode">Balanced</span>
                </div>
                <div class="status-row">
                  <span>Voices:</span>
                  <span id="active-voices">0 / 12</span>
                </div>
                <div class="status-row">
                  <span>Dropouts:</span>
                  <span id="dropout-count">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Status bar -->
  <div class="status-bar">
    <div class="status-item">
      <span class="status-label">BPM:</span>
      <span id="status-bpm">120</span>
    </div>
    <div class="status-item">
      <span class="status-label">Products:</span>
      <span id="status-products">0</span>
    </div>
    <div class="status-item">
      <span class="status-label">Mode:</span>
      <span id="status-mode">Normal</span>
    </div>
    <div class="status-links">
      <a href="https://livecodingstrasbourg.github.io" target="_blank">Live Coding Strasbourg</a> |
      <a href="supdoc/en.html" target="_blank">Docs</a>
    </div>
  </div>

  <div id="aisle-container">
    <div class="aisle-shelf top-shelf"></div>
    <div class="aisle-shelf middle-shelf"></div>
    <div class="aisle-shelf bottom-shelf"></div>
    <div class="floor-tiles"></div>
  </div>

  <!-- Overlays for atmosphere -->
  <div id="horror-elements"></div>
  <div id="neon-flicker"></div>
  <div class="noise-overlay"></div>

  <!-- Sound permissions overlay -->
  <div id="sound-permission" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; padding: 20px;">
    <h2>Enable Sound</h2>
    <p>This experience requires sound. Click the button below to enable audio.</p>
    <button id="enable-sound" style="padding: 15px 30px; background: #666; color: white; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; margin-top: 20px;">Enable Sound</button>
  </div>

  <!-- Sound initialization script -->
  <script>
    // Add audio debug logging (set to true for debugging)
    window.enableAudioDebug = false;
    
    // Sound initialization handler
    document.addEventListener('DOMContentLoaded', function() {
  // Get the sound permission button
  const enableSoundBtn = document.getElementById('enable-sound');
  const soundPermission = document.getElementById('sound-permission');
  
  if (enableSoundBtn && soundPermission) {
    enableSoundBtn.addEventListener('click', async function() {
      console.log("User clicked enable sound button");
      
      try {
        // SIMPLER APPROACH: Create an oscillator and immediately stop it
        // This is more reliable across browsers than the buffer approach
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        oscillator.connect(audioContext.destination);
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.001);
        
        // Wait a moment to make sure the oscillator has been processed
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Now try to start Tone.js
        console.log("Starting Tone.js...");
        await Tone.start();
        console.log("Tone.js started, state:", Tone.context.state);
        
        // Hide the permission overlay
        soundPermission.style.display = 'none';
        
        // Initialize the app with a delay to ensure everything is ready
        setTimeout(() => {
          if (window.initializeApplication) {
            window.initializeApplication();
          } else {
            console.error("initializeApplication function not found!");
          }
        }, 200);
      } catch (error) {
        console.error("Error initializing audio:", error);
        alert("There was an error enabling audio. Please refresh the page and try again.");
      }
    });
  } else {
    console.error("Sound permission elements not found!");
  }
});
  </script>
  
  <!-- Load JavaScript modules in the correct order -->
  <script src="supermarketjs/config.js"></script>
  <script src="supermarketjs/command-parser.js"></script>
  <script src="supermarketjs/product-types.js"></script>
  <script src="supermarketjs/audio-engine.js"></script>
  <script src="supermarketjs/cart-wheels.js"></script>
  <script src="supermarketjs/product-manager.js"></script>
  <script src="supermarketjs/mode-manager.js"></script>
  <script src="supermarketjs/visualization.js"></script>
  <script src="supermarketjs/ui-effects.js"></script>
  <script src="supermarketjs/ui-handlers.js"></script>
  <script src="supermarketjs/store-features.js"></script>
  <script src="supermarketjs/store-layout.js"></script>
  <script src="supermarketjs/performance-manager.js"></script>
  <script src="supermarketjs/audio-optimizations.js"></script>
  <script src="supermarketjs/shoplifting-system.js"></script>
  <script src="supermarketjs/story-mode.js"></script>
  <script src="supermarketjs/settings-manager.js"></script>
  <script src="supermarketjs/autocomplete.js"></script>
  <script src="supermarketjs/syntax-highlighter.js"></script>

  <!-- Audio debugging utility - optional, can be removed in production -->
  <script src="supermarketjs/audio-debug-utility.js"></script>
  
  <!-- Load main.js last -->
  <script src="supermarketjs/main.js"></script>
</body>
</html>